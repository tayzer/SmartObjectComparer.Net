@namespace ComparisonTool.Web.Components.Comparison
@using ComparisonTool.Core.Comparison.Analysis
@using ComparisonTool.Core.Comparison.Results
@using KellermanSoftware.CompareNetObjects

<style>
    /* Visual Diff Styles */
    .diff-expected {
        background-color: rgba(46, 125, 50, 0.15);
        border-left: 3px solid #2e7d32;
        padding: 0.5rem;
        border-radius: 4px;
        font-family: 'Consolas', 'Monaco', monospace;
    }
    
    .diff-actual {
        background-color: rgba(211, 47, 47, 0.15);
        border-left: 3px solid #d32f2f;
        padding: 0.5rem;
        border-radius: 4px;
        font-family: 'Consolas', 'Monaco', monospace;
    }
    
    .diff-value-expected {
        background-color: rgba(46, 125, 50, 0.25);
        color: #1b5e20;
        font-weight: 600;
        padding: 2px 6px;
        border-radius: 3px;
    }
    
    .diff-value-actual {
        background-color: rgba(211, 47, 47, 0.25);
        color: #b71c1c;
        font-weight: 600;
        padding: 2px 6px;
        border-radius: 3px;
    }
    
    /* Property Tree Styles */
    .property-tree-container {
        max-height: 500px;
        overflow-y: auto;
        border-right: 1px solid var(--mud-palette-lines-default);
    }
    
    .property-node {
        padding: 8px 12px;
        cursor: pointer;
        border-bottom: 1px solid var(--mud-palette-lines-default);
        transition: background-color 0.15s;
    }
    
    .property-node:hover {
        background-color: var(--mud-palette-action-default-hover);
    }
    
    .property-node.selected {
        background-color: var(--mud-palette-primary);
        color: white;
    }
    
    .property-node.selected .mud-chip {
        background-color: rgba(255,255,255,0.3);
        color: white;
    }
    
    .details-panel {
        max-height: 500px;
        overflow-y: auto;
        padding: 16px;
    }
    
    .file-diff-card {
        margin-bottom: 12px;
    }
    
    /* Tree View Styles */
    .tree-node-content {
        display: flex;
        align-items: center;
        justify-content: space-between;
        width: 100%;
        padding: 4px 8px;
        border-radius: 4px;
        cursor: pointer;
    }
    
    .tree-node-content:hover {
        background-color: var(--mud-palette-action-default-hover);
    }
    
    .tree-node-content.selected {
        background-color: var(--mud-palette-primary);
        color: white;
    }
    
    .tree-node-content.selected .mud-chip {
        background-color: rgba(255,255,255,0.3) !important;
        color: white !important;
    }
    
    .tree-node-label {
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .tree-leaf-icon {
        color: var(--mud-palette-info);
    }
    
    .tree-branch-icon {
        color: var(--mud-palette-warning);
    }
</style>

<!-- Summary Header with MudPaper and MudChips -->
<MudPaper Elevation="3" Class="pa-4 mb-4" Style="background: linear-gradient(135deg, #1976d2 0%, #7b1fa2 100%);">
    <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Class="mb-4">
        <MudStack Spacing="1">
            <MudText Typo="Typo.h5" Style="color: white;">
                <MudIcon Icon="@Icons.Material.Filled.Assessment" Class="mr-2" />
                Comparison Run Details
            </MudText>
            <MudText Typo="Typo.body2" Style="color: rgba(255,255,255,0.8);">
                In-depth analysis of differences between expected and actual results
            </MudText>
        </MudStack>
        <MudStack Row="true" Spacing="2">
            <MudButton Variant="Variant.Outlined" 
                       Color="Color.Default" 
                       Size="Size.Small" 
                       StartIcon="@Icons.Material.Filled.Refresh"
                       Style="color: white; border-color: rgba(255,255,255,0.5);"
                       OnClick="RefreshAnalysis">
                Refresh
            </MudButton>
            <MudButton Variant="Variant.Outlined" 
                       Color="Color.Default" 
                       Size="Size.Small" 
                       StartIcon="@Icons.Material.Filled.Download"
                       Style="color: white; border-color: rgba(255,255,255,0.5);"
                       OnClick="ExportResults">
                Export
            </MudButton>
        </MudStack>
    </MudStack>
    
    <!-- Summary Stats - Using consistent text display for numbers -->
    <div style="display: flex; flex-wrap: wrap; justify-content: center; gap: 12px;">
        <MudTooltip Text="Total file pairs compared (excluding errors)">
            <MudPaper Elevation="0" Class="pa-3 text-center" Style="background: rgba(255,255,255,0.15); border-radius: 8px; width: 120px;">
                <MudText Typo="Typo.h5" Style="color: white; font-weight: 700;">@GetTotalFilesAnalyzed()</MudText>
                <MudText Typo="Typo.caption" Style="color: rgba(255,255,255,0.9); text-transform: uppercase; font-size: 0.65rem;">Analyzed</MudText>
            </MudPaper>
        </MudTooltip>
        <MudTooltip Text="@($"Files with at least one difference ({GetFilesWithoutDifferences()} files are identical)")">
            <MudPaper Elevation="0" Class="pa-3 text-center" Style="background: rgba(255,255,255,0.15); border-radius: 8px; width: 120px;">
                <MudText Typo="Typo.h5" Style="color: white; font-weight: 700;">@GetTotalFilesWithDifferences()</MudText>
                <MudText Typo="Typo.caption" Style="color: rgba(255,255,255,0.9); text-transform: uppercase; font-size: 0.65rem;">Different</MudText>
            </MudPaper>
        </MudTooltip>
        @if (GetFilesWithErrorsCount() > 0)
        {
            <MudTooltip Text="Files that failed during comparison (click for details)">
                <MudPaper Elevation="0" Class="pa-3 text-center" Style="background: rgba(244,67,54,0.3); border-radius: 8px; width: 120px; border: 1px solid rgba(244,67,54,0.5);">
                    <MudText Typo="Typo.h5" Style="color: #ffcdd2; font-weight: 700;">@GetFilesWithErrorsCount()</MudText>
                    <MudText Typo="Typo.caption" Style="color: rgba(255,255,255,0.9); text-transform: uppercase; font-size: 0.65rem;">Errors</MudText>
                </MudPaper>
            </MudTooltip>
        }
        <MudTooltip Text="Property value mismatches (numeric, text, boolean, date changes)">
            <MudPaper Elevation="0" Class="pa-3 text-center" Style="background: rgba(33,150,243,0.3); border-radius: 8px; width: 120px; border: 1px solid rgba(33,150,243,0.5);">
                <MudText Typo="Typo.h5" Style="color: #90caf9; font-weight: 700;">@GetValueDifferencesCount()</MudText>
                <MudText Typo="Typo.caption" Style="color: rgba(255,255,255,0.9); text-transform: uppercase; font-size: 0.65rem;">Value Diffs</MudText>
            </MudPaper>
        </MudTooltip>
        <MudTooltip Text="Missing or null properties (properties present in expected but missing in actual)">
            <MudPaper Elevation="0" Class="pa-3 text-center" Style="background: rgba(156,39,176,0.3); border-radius: 8px; width: 120px; border: 1px solid rgba(156,39,176,0.5);">
                <MudText Typo="Typo.h5" Style="color: #ce93d8; font-weight: 700;">@GetMissingPropertiesCount()</MudText>
                <MudText Typo="Typo.caption" Style="color: rgba(255,255,255,0.9); text-transform: uppercase; font-size: 0.65rem;">Missing Props</MudText>
            </MudPaper>
        </MudTooltip>
        <MudTooltip Text="Collection ordering differences (items reordered within collections)">
            <MudPaper Elevation="0" Class="pa-3 text-center" Style="background: rgba(255,152,0,0.3); border-radius: 8px; width: 120px; border: 1px solid rgba(255,152,0,0.5);">
                <MudText Typo="Typo.h5" Style="color: #ffcc80; font-weight: 700;">@GetOrderingDifferencesCount()</MudText>
                <MudText Typo="Typo.caption" Style="color: rgba(255,255,255,0.9); text-transform: uppercase; font-size: 0.65rem;">Order Diffs</MudText>
            </MudPaper>
        </MudTooltip>
        <MudTooltip Text="Differences that could not be categorized">
            <MudPaper Elevation="0" Class="pa-3 text-center" Style="background: rgba(158,158,158,0.3); border-radius: 8px; width: 120px; border: 1px solid rgba(158,158,158,0.5);">
                <MudText Typo="Typo.h5" Style="color: #e0e0e0; font-weight: 700;">@GetUncategorizedCount()</MudText>
                <MudText Typo="Typo.caption" Style="color: rgba(255,255,255,0.9); text-transform: uppercase; font-size: 0.65rem;">Other</MudText>
            </MudPaper>
        </MudTooltip>
        <MudTooltip Text="Critical structural issues (missing/extra fields, type changes)">
            <MudPaper Elevation="0" Class="pa-3 text-center" Style="background: rgba(244,67,54,0.3); border-radius: 8px; width: 120px; border: 1px solid rgba(244,67,54,0.5);">
                <MudText Typo="Typo.h5" Style="color: #ef9a9a; font-weight: 700;">@GetCriticalIssuesCount()</MudText>
                <MudText Typo="Typo.caption" Style="color: rgba(255,255,255,0.9); text-transform: uppercase; font-size: 0.65rem;">Critical</MudText>
            </MudPaper>
        </MudTooltip>
        <MudTooltip Text="Sum of all differences across all files">
            <MudPaper Elevation="0" Class="pa-3 text-center" Style="background: rgba(255,255,255,0.25); border-radius: 8px; width: 120px; border: 1px solid rgba(255,255,255,0.4);">
                <MudText Typo="Typo.h5" Style="color: white; font-weight: 700;">@GetTotalDifferencesCount()</MudText>
                <MudText Typo="Typo.caption" Style="color: rgba(255,255,255,0.9); text-transform: uppercase; font-size: 0.65rem;">Total</MudText>
            </MudPaper>
        </MudTooltip>
    </div>
</MudPaper>

@if (GetFilesWithErrorsCount() > 0)
{
    <MudExpansionPanels Class="mb-4">
        <MudExpansionPanel Text="@($"⚠️ {GetFilesWithErrorsCount()} file(s) had errors during comparison")" 
                           MaxHeight="300"
                           Style="background-color: #fff3e0;">
            <MudAlert Severity="Severity.Warning" Variant="Variant.Text" Dense="true" Class="mb-2">
                These files could not be compared and are NOT counted as "equal" or "different". 
                They may affect your difference totals.
            </MudAlert>
            <MudList T="string" Dense="true">
                @foreach (var errorFile in GetFilesWithErrors())
                {
                    <MudListItem Icon="@Icons.Material.Filled.Error" IconColor="Color.Error">
                        <MudStack Spacing="0">
                            <MudText Typo="Typo.body2"><strong>@errorFile.File1Name</strong></MudText>
                            <MudText Typo="Typo.caption" Color="Color.Error">@errorFile.ErrorMessage</MudText>
                        </MudStack>
                    </MudListItem>
                }
            </MudList>
        </MudExpansionPanel>
    </MudExpansionPanels>
}

<!-- Top Affected Objects Panel -->
@if (FolderComparisonResult != null && !FolderComparisonResult.AllEqual)
{
    <TopAffectedObjectsPanel FolderResult="@FolderComparisonResult"
                             Analysis="@Analysis" />
}

<!-- Inspectors in MudTabs -->
<MudPaper Elevation="2" Class="pa-0">
    <MudTabs Elevation="0" Rounded="true" ApplyEffectsToContainer="true" PanelClass="pa-0" @bind-ActivePanelIndex="ActiveTabIndex">
        <!-- Value Differences Tab -->
        <MudTabPanel Text="Value Differences" Icon="@Icons.Material.Filled.Edit" BadgeData="@GetValueDifferencesCount()" BadgeColor="Color.Info">
            <MudGrid Spacing="0">
                <!-- Left Panel: Hierarchical Tree Navigator -->
                <MudItem xs="12" md="4">
                    <div class="property-tree-container">
                        <MudStack Class="pa-3" Spacing="2">
                            <MudTextField @bind-Value="ValuePropertyFilter" 
                                          Placeholder="Filter by path..." 
                                          Variant="Variant.Outlined" 
                                          Adornment="Adornment.Start" 
                                          AdornmentIcon="@Icons.Material.Filled.Search"
                                          Immediate="true"
                                          Margin="Margin.Dense"
                                          Size="Size.Small" />
                            <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                                <MudText Typo="Typo.caption" Color="Color.Secondary">
                                    @_valueTreeNodes.Sum(n => CountLeafNodes(n)) properties
                                </MudText>
                                <MudButtonGroup Size="Size.Small" Variant="Variant.Outlined">
                                    <MudIconButton Icon="@Icons.Material.Filled.UnfoldMore" Size="Size.Small" OnClick="ExpandAllValueNodes" Title="Expand All" />
                                    <MudIconButton Icon="@Icons.Material.Filled.UnfoldLess" Size="Size.Small" OnClick="CollapseAllValueNodes" Title="Collapse All" />
                                </MudButtonGroup>
                            </MudStack>
                        </MudStack>
                        
                        @if (_valueTreeNodes.Any())
                        {
                            <MudTreeView T="string" Items="_valueTreeNodes" Hover="true" Dense="true" Class="pa-2">
                                <ItemTemplate>
                                    @{
                                        var node = context as PropertyTreeNode;
                                    }
                                    @if (node != null)
                                    {
                                        <MudTreeViewItem T="string" 
                                                         @bind-Expanded="@context.Expanded" 
                                                         Items="@context.Children"
                                                         Value="@context.Value"
                                                         OnClick="@(() => SelectTreeNode(context))">
                                            <BodyContent Context="_">
                                                <div class="tree-node-content @(node.FullPath == SelectedValueProperty ? "selected" : "")">
                                                    <span class="tree-node-label">
                                                        @if (node.IsLeaf)
                                                        {
                                                            <MudIcon Icon="@Icons.Material.Filled.Circle" Size="Size.Small" Class="tree-leaf-icon" Style="font-size: 10px;" />
                                                        }
                                                        else
                                                        {
                                                            <MudIcon Icon="@Icons.Material.Filled.Folder" Size="Size.Small" Class="tree-branch-icon" />
                                                        }
                                                        <span>@node.Name</span>
                                                    </span>
                                                    <MudChip T="string" Size="Size.Small" Color="@(node.IsLeaf ? Color.Info : Color.Default)" Variant="Variant.Text">
                                                        @node.DifferenceCount
                                                    </MudChip>
                                                </div>
                                            </BodyContent>
                                        </MudTreeViewItem>
                                    }
                                </ItemTemplate>
                            </MudTreeView>
                        }
                        else
                        {
                            <MudAlert Severity="Severity.Info" Variant="Variant.Text" Class="ma-3">
                                No value differences found.
                            </MudAlert>
                        }
                    </div>
                </MudItem>
                
                <!-- Right Panel: File Differences -->
                <MudItem xs="12" md="8">
                    <div class="details-panel">
                        @if (!string.IsNullOrEmpty(SelectedValueProperty) && _valuePropertyGroups.ContainsKey(SelectedValueProperty))
                        {
                            var files = _valuePropertyGroups[SelectedValueProperty];
                            <MudStack Spacing="3">
                                <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                                    <MudText Typo="Typo.h6">
                                        <MudIcon Icon="@Icons.Material.Filled.Code" Class="mr-2" />
                                        <code>@SelectedValueProperty</code>
                                    </MudText>
                                    <MudChip T="string" Size="Size.Small" Color="Color.Info">@files.Count files affected</MudChip>
                                </MudStack>
                                
                                <MudDivider />
                                
                                @foreach (var file in files.Take(50))
                                {
                                    <MudPaper Outlined="true" Class="file-diff-card pa-3">
                                        <MudStack Spacing="2">
                                            <MudStack Row="true" AlignItems="AlignItems.Center">
                                                <MudIcon Icon="@Icons.Material.Filled.InsertDriveFile" Size="Size.Small" Color="Color.Secondary" />
                                                <MudLink Typo="Typo.body2" Color="Color.Primary" Style="cursor: pointer; font-weight: 600;" OnClick="@(() => NavigateToFilePair(file.FileName))">
                                                    @file.FileName
                                                </MudLink>
                                                <MudTooltip Text="View detailed comparison for this file pair">
                                                    <MudIconButton Icon="@Icons.Material.Filled.OpenInNew" Size="Size.Small" Color="Color.Primary" OnClick="@(() => NavigateToFilePair(file.FileName))" />
                                                </MudTooltip>
                                            </MudStack>
                                            
                                            <MudGrid Spacing="2">
                                                <MudItem xs="12" sm="6">
                                                    <div class="diff-expected">
                                                        <MudText Typo="Typo.caption" Color="Color.Success" Class="mb-1">
                                                            <MudIcon Icon="@Icons.Material.Filled.CheckCircle" Size="Size.Small" Class="mr-1" />
                                                            Expected
                                                        </MudText>
                                                        <MudText Typo="Typo.body2">
                                                            <span class="diff-value-expected">@file.ExpectedValue</span>
                                                        </MudText>
                                                    </div>
                                                </MudItem>
                                                <MudItem xs="12" sm="6">
                                                    <div class="diff-actual">
                                                        <MudText Typo="Typo.caption" Color="Color.Error" Class="mb-1">
                                                            <MudIcon Icon="@Icons.Material.Filled.Cancel" Size="Size.Small" Class="mr-1" />
                                                            Actual
                                                        </MudText>
                                                        <MudText Typo="Typo.body2">
                                                            <span class="diff-value-actual">@file.ActualValue</span>
                                                        </MudText>
                                                    </div>
                                                </MudItem>
                                            </MudGrid>
                                        </MudStack>
                                    </MudPaper>
                                }
                                
                                @if (files.Count > 50)
                                {
                                    <MudAlert Severity="Severity.Info" Variant="Variant.Outlined">
                                        Showing first 50 of @files.Count files. Use the filter to narrow down results.
                                    </MudAlert>
                                }
                            </MudStack>
                        }
                        else
                        {
                            <MudStack AlignItems="AlignItems.Center" Justify="Justify.Center" Class="pa-8" Style="min-height: 300px;">
                                <MudIcon Icon="@Icons.Material.Filled.TouchApp" Size="Size.Large" Color="Color.Secondary" />
                                <MudText Typo="Typo.h6" Color="Color.Secondary">Select a Property</MudText>
                                <MudText Typo="Typo.body2" Color="Color.Secondary">
                                    Click on a property in the left panel to see which files have differences
                                </MudText>
                            </MudStack>
                        }
                    </div>
                </MudItem>
            </MudGrid>
        </MudTabPanel>
        
        <!-- Ordering Differences Tab -->
        <MudTabPanel Text="Ordering Differences" Icon="@Icons.Material.Filled.SwapVert" BadgeData="@GetOrderingDifferencesCount()" BadgeColor="Color.Warning">
            <MudGrid Spacing="0">
                <!-- Left Panel: Hierarchical Tree Navigator -->
                <MudItem xs="12" md="4">
                    <div class="property-tree-container">
                        <MudStack Class="pa-3" Spacing="2">
                            <MudTextField @bind-Value="OrderPropertyFilter" 
                                          Placeholder="Filter by path..." 
                                          Variant="Variant.Outlined" 
                                          Adornment="Adornment.Start" 
                                          AdornmentIcon="@Icons.Material.Filled.Search"
                                          Immediate="true"
                                          Margin="Margin.Dense"
                                          Size="Size.Small" />
                            <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                                <MudText Typo="Typo.caption" Color="Color.Secondary">
                                    @_orderTreeNodes.Sum(n => CountLeafNodes(n)) collections
                                </MudText>
                                <MudButtonGroup Size="Size.Small" Variant="Variant.Outlined">
                                    <MudIconButton Icon="@Icons.Material.Filled.UnfoldMore" Size="Size.Small" OnClick="ExpandAllOrderNodes" Title="Expand All" />
                                    <MudIconButton Icon="@Icons.Material.Filled.UnfoldLess" Size="Size.Small" OnClick="CollapseAllOrderNodes" Title="Collapse All" />
                                </MudButtonGroup>
                            </MudStack>
                        </MudStack>
                        
                        @if (_orderTreeNodes.Any())
                        {
                            <MudTreeView T="string" Items="_orderTreeNodes" Hover="true" Dense="true" Class="pa-2">
                                <ItemTemplate>
                                    @{
                                        var node = context as PropertyTreeNode;
                                    }
                                    @if (node != null)
                                    {
                                        <MudTreeViewItem T="string" 
                                                         @bind-Expanded="@context.Expanded" 
                                                         Items="@context.Children"
                                                         Value="@context.Value"
                                                         OnClick="@(() => SelectOrderTreeNode(context))">
                                            <BodyContent Context="_">
                                                <div class="tree-node-content @(node.FullPath == SelectedOrderProperty ? "selected" : "")">
                                                    <span class="tree-node-label">
                                                        @if (node.IsLeaf)
                                                        {
                                                            <MudIcon Icon="@Icons.Material.Filled.Circle" Size="Size.Small" Class="tree-leaf-icon" Style="font-size: 10px;" />
                                                        }
                                                        else
                                                        {
                                                            <MudIcon Icon="@Icons.Material.Filled.Folder" Size="Size.Small" Class="tree-branch-icon" />
                                                        }
                                                        <span>@node.Name</span>
                                                    </span>
                                                    <MudChip T="string" Size="Size.Small" Color="@(node.IsLeaf ? Color.Warning : Color.Default)" Variant="Variant.Text">
                                                        @node.DifferenceCount
                                                    </MudChip>
                                                </div>
                                            </BodyContent>
                                        </MudTreeViewItem>
                                    }
                                </ItemTemplate>
                            </MudTreeView>
                        }
                        else
                        {
                            <MudAlert Severity="Severity.Info" Variant="Variant.Text" Class="ma-3">
                                No ordering differences found.
                            </MudAlert>
                        }
                    </div>
                </MudItem>
                
                <MudItem xs="12" md="8">
                    <div class="details-panel">
                        @if (!string.IsNullOrEmpty(SelectedOrderProperty) && _orderPropertyGroups.ContainsKey(SelectedOrderProperty))
                        {
                            var files = _orderPropertyGroups[SelectedOrderProperty];
                            <MudStack Spacing="3">
                                <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                                    <MudText Typo="Typo.h6">
                                        <MudIcon Icon="@Icons.Material.Filled.SwapVert" Class="mr-2" />
                                        <code>@SelectedOrderProperty</code>
                                    </MudText>
                                    <MudChip T="string" Size="Size.Small" Color="Color.Warning">@files.Count files affected</MudChip>
                                </MudStack>
                                
                                <MudDivider />
                                
                                @foreach (var file in files.Take(50))
                                {
                                    <MudPaper Outlined="true" Class="file-diff-card pa-3">
                                        <MudStack Spacing="2">
                                            <MudStack Row="true" AlignItems="AlignItems.Center">
                                                <MudIcon Icon="@Icons.Material.Filled.InsertDriveFile" Size="Size.Small" Color="Color.Secondary" />
                                                <MudLink Typo="Typo.body2" Color="Color.Primary" Style="cursor: pointer; font-weight: 600;" OnClick="@(() => NavigateToFilePair(file.FileName))">
                                                    @file.FileName
                                                </MudLink>
                                                <MudTooltip Text="View detailed comparison for this file pair">
                                                    <MudIconButton Icon="@Icons.Material.Filled.OpenInNew" Size="Size.Small" Color="Color.Primary" OnClick="@(() => NavigateToFilePair(file.FileName))" />
                                                </MudTooltip>
                                            </MudStack>
                                            
                                            <MudGrid Spacing="2">
                                                <MudItem xs="12" sm="6">
                                                    <div class="diff-expected">
                                                        <MudText Typo="Typo.caption" Color="Color.Success" Class="mb-1">Expected Position</MudText>
                                                        <MudText Typo="Typo.body2">
                                                            <span class="diff-value-expected">@file.ExpectedValue</span>
                                                        </MudText>
                                                    </div>
                                                </MudItem>
                                                <MudItem xs="12" sm="6">
                                                    <div class="diff-actual">
                                                        <MudText Typo="Typo.caption" Color="Color.Error" Class="mb-1">Actual Position</MudText>
                                                        <MudText Typo="Typo.body2">
                                                            <span class="diff-value-actual">@file.ActualValue</span>
                                                        </MudText>
                                                    </div>
                                                </MudItem>
                                            </MudGrid>
                                        </MudStack>
                                    </MudPaper>
                                }
                            </MudStack>
                        }
                        else
                        {
                            <MudStack AlignItems="AlignItems.Center" Justify="Justify.Center" Class="pa-8" Style="min-height: 300px;">
                                <MudIcon Icon="@Icons.Material.Filled.TouchApp" Size="Size.Large" Color="Color.Secondary" />
                                <MudText Typo="Typo.h6" Color="Color.Secondary">Select a Collection</MudText>
                                <MudText Typo="Typo.body2" Color="Color.Secondary">
                                    Click on a collection in the left panel to see ordering changes
                                </MudText>
                            </MudStack>
                        }
                    </div>
                </MudItem>
            </MudGrid>
        </MudTabPanel>
        
        <!-- Critical Issues Tab -->
        <MudTabPanel Text="Critical Issues" Icon="@Icons.Material.Filled.Warning" BadgeData="@GetCriticalIssuesCount()" BadgeColor="Color.Error">
            <MudGrid Spacing="0">
                <MudItem xs="12" md="4">
                    <div class="property-tree-container">
                        <MudStack Class="pa-3" Spacing="2">
                            <MudTextField @bind-Value="CriticalPropertyFilter" 
                                          Placeholder="Filter critical properties..." 
                                          Variant="Variant.Outlined" 
                                          Adornment="Adornment.Start" 
                                          AdornmentIcon="@Icons.Material.Filled.Search"
                                          Immediate="true"
                                          Margin="Margin.Dense"
                                          Size="Size.Small" />
                            <MudText Typo="Typo.caption" Color="Color.Secondary">
                                @GetFilteredCriticalProperties().Count() critical properties with issues
                            </MudText>
                        </MudStack>
                        
                        @foreach (var kvp in GetFilteredCriticalProperties().OrderBy(x => x.Key))
                        {
                            var prop = kvp.Key;
                            var files = kvp.Value;
                            var isSelected = prop == SelectedCriticalProperty;
                            <div class="property-node @(isSelected ? "selected" : "")" @onclick="@(() => SelectCriticalProperty(prop))">
                                <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                                    <MudStack Spacing="0">
                                        <MudText Typo="Typo.body2" Style="@(isSelected ? "color: white;" : "")">
                                            <strong>@GetPropertyDisplayName(prop)</strong>
                                        </MudText>
                                        <MudText Typo="Typo.caption" Style="@(isSelected ? "color: rgba(255,255,255,0.8);" : "")">
                                            @prop
                                        </MudText>
                                    </MudStack>
                                    <MudChip T="string" Size="Size.Small" Color="Color.Error">@files.Count</MudChip>
                                </MudStack>
                            </div>
                        }
                        
                        @if (!_criticalPropertyGroups.Any())
                        {
                            <MudAlert Severity="Severity.Success" Variant="Variant.Text" Class="ma-3">
                                No critical issues found.
                            </MudAlert>
                        }
                    </div>
                </MudItem>
                
                <MudItem xs="12" md="8">
                    <div class="details-panel">
                        @if (!string.IsNullOrEmpty(SelectedCriticalProperty) && _criticalPropertyGroups.ContainsKey(SelectedCriticalProperty))
                        {
                            var files = _criticalPropertyGroups[SelectedCriticalProperty];
                            <MudStack Spacing="3">
                                <MudAlert Severity="Severity.Error" Variant="Variant.Filled" Class="mb-2">
                                    <MudText><strong>Critical Property:</strong> This property is vital to system functionality.</MudText>
                                </MudAlert>
                                
                                <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                                    <MudText Typo="Typo.h6">
                                        <MudIcon Icon="@Icons.Material.Filled.Warning" Class="mr-2" Color="Color.Error" />
                                        <code>@SelectedCriticalProperty</code>
                                    </MudText>
                                    <MudChip T="string" Size="Size.Small" Color="Color.Error">@files.Count files affected</MudChip>
                                </MudStack>
                                
                                <MudDivider />
                                
                                @foreach (var file in files.Take(50))
                                {
                                    <MudPaper Outlined="true" Class="file-diff-card pa-3" Style="border-color: var(--mud-palette-error);">
                                        <MudStack Spacing="2">
                                            <MudStack Row="true" AlignItems="AlignItems.Center">
                                                <MudIcon Icon="@Icons.Material.Filled.Error" Size="Size.Small" Color="Color.Error" />
                                                <MudLink Typo="Typo.body2" Color="Color.Primary" Style="cursor: pointer; font-weight: 600;" OnClick="@(() => NavigateToFilePair(file.FileName))">
                                                    @file.FileName
                                                </MudLink>
                                                <MudTooltip Text="View detailed comparison for this file pair">
                                                    <MudIconButton Icon="@Icons.Material.Filled.OpenInNew" Size="Size.Small" Color="Color.Primary" OnClick="@(() => NavigateToFilePair(file.FileName))" />
                                                </MudTooltip>
                                            </MudStack>
                                            
                                            <MudGrid Spacing="2">
                                                <MudItem xs="12" sm="6">
                                                    <div class="diff-expected">
                                                        <MudText Typo="Typo.caption" Color="Color.Success" Class="mb-1">Expected</MudText>
                                                        <MudText Typo="Typo.body2">
                                                            <span class="diff-value-expected">@file.ExpectedValue</span>
                                                        </MudText>
                                                    </div>
                                                </MudItem>
                                                <MudItem xs="12" sm="6">
                                                    <div class="diff-actual">
                                                        <MudText Typo="Typo.caption" Color="Color.Error" Class="mb-1">Actual</MudText>
                                                        <MudText Typo="Typo.body2">
                                                            <span class="diff-value-actual">@file.ActualValue</span>
                                                        </MudText>
                                                    </div>
                                                </MudItem>
                                            </MudGrid>
                                        </MudStack>
                                    </MudPaper>
                                }
                            </MudStack>
                        }
                        else
                        {
                            <MudStack AlignItems="AlignItems.Center" Justify="Justify.Center" Class="pa-8" Style="min-height: 300px;">
                                <MudIcon Icon="@Icons.Material.Filled.CheckCircle" Size="Size.Large" Color="Color.Success" />
                                <MudText Typo="Typo.h6" Color="Color.Secondary">No Critical Issues Selected</MudText>
                                <MudText Typo="Typo.body2" Color="Color.Secondary">
                                    Select a property to view critical differences
                                </MudText>
                            </MudStack>
                        }
                    </div>
                </MudItem>
            </MudGrid>
        </MudTabPanel>
        
        <!-- All Differences Tab -->
        <MudTabPanel Text="All Differences" Icon="@Icons.Material.Filled.List">
            <MudStack Spacing="3" Class="pa-4">
                <MudTextField @bind-Value="AllDifferencesFilter" 
                              Placeholder="Search all differences..." 
                              Variant="Variant.Outlined" 
                              Adornment="Adornment.Start" 
                              AdornmentIcon="@Icons.Material.Filled.Search"
                              Immediate="true"
                              Margin="Margin.Dense" />
                
                @if (GetFilteredAllDifferences().Any())
                {
                    <MudDataGrid T="DifferenceGridItem" 
                                 Items="@GetFilteredAllDifferences()" 
                                 Dense="true" 
                                 Hover="true" 
                                 Striped="true"
                                 Filterable="true"
                                 SortMode="SortMode.Multiple"
                                 Groupable="true"
                                 RowsPerPage="50">
                        <Columns>
                            <TemplateColumn Title="Type" Sortable="true">
                                <CellTemplate>
                                    @if (context.Item.IsCritical)
                                    {
                                        <MudChip T="string" Size="Size.Small" Color="Color.Error" Icon="@Icons.Material.Filled.Error">Critical</MudChip>
                                    }
                                    else if (context.Item.IsOrdering)
                                    {
                                        <MudChip T="string" Size="Size.Small" Color="Color.Warning" Icon="@Icons.Material.Filled.SwapVert">Order</MudChip>
                                    }
                                    else
                                    {
                                        <MudChip T="string" Size="Size.Small" Color="Color.Info" Icon="@Icons.Material.Filled.Edit">Value</MudChip>
                                    }
                                </CellTemplate>
                            </TemplateColumn>
                            <PropertyColumn Property="x => x.PropertyPath" Title="Property" Sortable="true" Groupable="true">
                                <CellTemplate>
                                    <MudText Typo="Typo.body2"><code>@context.Item.PropertyPath</code></MudText>
                                </CellTemplate>
                            </PropertyColumn>
                            <TemplateColumn Title="File" Sortable="true" Groupable="true">
                                <CellTemplate>
                                    <MudLink Color="Color.Primary" Style="cursor: pointer;" OnClick="@(() => NavigateToFilePair(context.Item.FileName))">
                                        @context.Item.FileName
                                    </MudLink>
                                </CellTemplate>
                            </TemplateColumn>
                            <TemplateColumn Title="Expected" Sortable="false">
                                <CellTemplate>
                                    <div class="diff-expected">
                                        <span class="diff-value-expected">@context.Item.ExpectedValue</span>
                                    </div>
                                </CellTemplate>
                            </TemplateColumn>
                            <TemplateColumn Title="Actual" Sortable="false">
                                <CellTemplate>
                                    <div class="diff-actual">
                                        <span class="diff-value-actual">@context.Item.ActualValue</span>
                                    </div>
                                </CellTemplate>
                            </TemplateColumn>
                            <PropertyColumn Property="x => x.Category" Title="Category" Sortable="true" Groupable="true" />
                        </Columns>
                        <PagerContent>
                            <MudDataGridPager T="DifferenceGridItem" />
                        </PagerContent>
                    </MudDataGrid>
                }
                else
                {
                    <MudAlert Severity="Severity.Success" Variant="Variant.Outlined" Icon="@Icons.Material.Filled.CheckCircle">
                        <MudText>No differences found matching the filter criteria.</MudText>
                    </MudAlert>
                }
            </MudStack>
        </MudTabPanel>
    </MudTabs>
</MudPaper>

@code {
    [Parameter]
    public EnhancedStructuralDifferenceAnalyzer.EnhancedStructuralAnalysisResult Analysis { get; set; }
    
    [Parameter]
    public MultiFolderComparisonResult FolderComparisonResult { get; set; }
    
    /// <summary>
    /// Fires when a file name is clicked in any inspector tab, passing the file name to navigate to.
    /// </summary>
    [Parameter]
    public EventCallback<string> OnFileSelected { get; set; }
    
    private int ActiveTabIndex { get; set; } = 0;
    
    private string SelectedValueProperty { get; set; } = "";
    private string SelectedOrderProperty { get; set; } = "";
    private string SelectedCriticalProperty { get; set; } = "";
    
    private string ValuePropertyFilter { get; set; } = "";
    private string OrderPropertyFilter { get; set; } = "";
    private string CriticalPropertyFilter { get; set; } = "";
    private string AllDifferencesFilter { get; set; } = "";
    
    private Dictionary<string, List<FileDifference>> _valuePropertyGroups = new();
    private Dictionary<string, List<FileDifference>> _orderPropertyGroups = new();
    private Dictionary<string, List<FileDifference>> _criticalPropertyGroups = new();
    private List<DifferenceGridItem> _allDifferences = new();
    
    // Tree view data structures
    private List<TreeItemData<string>> _valueTreeNodes = new();
    private List<TreeItemData<string>> _orderTreeNodes = new();
    
    public class PropertyTreeNode : TreeItemData<string>
    {
        public string Name { get; set; } = "";
        public string FullPath { get; set; } = "";
        public bool IsLeaf { get; set; } = false;
        public int DifferenceCount { get; set; } = 0;
        public List<FileDifference> Differences { get; set; } = new();
        
        public PropertyTreeNode() : base() 
        {
            Expanded = true;
        }
        
        public PropertyTreeNode(string name, string fullPath) : base(fullPath)
        {
            Name = name;
            FullPath = fullPath;
            Text = name;
            Expanded = true;
        }
    }
    
    public class FileDifference
    {
        public string FileName { get; set; } = "";
        public string ExpectedValue { get; set; } = "";
        public string ActualValue { get; set; } = "";
        public string Category { get; set; } = "";
    }
    
    public class DifferenceGridItem
    {
        public string PropertyPath { get; set; } = "";
        public string FileName { get; set; } = "";
        public string ExpectedValue { get; set; } = "";
        public string ActualValue { get; set; } = "";
        public string Category { get; set; } = "";
        public bool IsCritical { get; set; }
        public bool IsOrdering { get; set; }
    }
    
    protected override void OnParametersSet()
    {
        BuildPropertyGroups();
    }
    
    private void BuildPropertyGroups()
    {
        _valuePropertyGroups.Clear();
        _orderPropertyGroups.Clear();
        _criticalPropertyGroups.Clear();
        _allDifferences.Clear();
        
        if (Analysis?.AllPatterns == null) return;
        
        foreach (var pattern in Analysis.AllPatterns)
        {
            var isValue = IsValueDifference(pattern.Category);
            var isOrder = IsOrderingDifference(pattern.Category);
            var isCritical = pattern.IsCriticalProperty;
            var propertyPath = ExtractBasePropertyPath(pattern.FullPattern);
            
            foreach (var file in pattern.AffectedFiles.Distinct())
            {
                var example = pattern.Examples.FirstOrDefault();
                var fileDiff = new FileDifference
                {
                    FileName = file,
                    ExpectedValue = FormatValue(example?.Object1Value),
                    ActualValue = FormatValue(example?.Object2Value),
                    Category = pattern.Category.ToString()
                };
                
                var gridItem = new DifferenceGridItem
                {
                    PropertyPath = propertyPath,
                    FileName = file,
                    ExpectedValue = fileDiff.ExpectedValue,
                    ActualValue = fileDiff.ActualValue,
                    Category = pattern.Category.ToString(),
                    IsCritical = isCritical,
                    IsOrdering = isOrder
                };
                _allDifferences.Add(gridItem);
                
                if (isCritical)
                {
                    if (!_criticalPropertyGroups.ContainsKey(propertyPath))
                        _criticalPropertyGroups[propertyPath] = new List<FileDifference>();
                    _criticalPropertyGroups[propertyPath].Add(fileDiff);
                }
                else if (isOrder)
                {
                    if (!_orderPropertyGroups.ContainsKey(propertyPath))
                        _orderPropertyGroups[propertyPath] = new List<FileDifference>();
                    _orderPropertyGroups[propertyPath].Add(fileDiff);
                }
                else if (isValue)
                {
                    if (!_valuePropertyGroups.ContainsKey(propertyPath))
                        _valuePropertyGroups[propertyPath] = new List<FileDifference>();
                    _valuePropertyGroups[propertyPath].Add(fileDiff);
                }
            }
        }
        
        if (_valuePropertyGroups.Any() && string.IsNullOrEmpty(SelectedValueProperty))
            SelectedValueProperty = _valuePropertyGroups.Keys.First();
        if (_orderPropertyGroups.Any() && string.IsNullOrEmpty(SelectedOrderProperty))
            SelectedOrderProperty = _orderPropertyGroups.Keys.First();
        if (_criticalPropertyGroups.Any() && string.IsNullOrEmpty(SelectedCriticalProperty))
            SelectedCriticalProperty = _criticalPropertyGroups.Keys.First();
        
        // Build hierarchical tree views
        _valueTreeNodes = BuildPropertyTree(_valuePropertyGroups);
        _orderTreeNodes = BuildPropertyTree(_orderPropertyGroups);
    }
    
    private List<TreeItemData<string>> BuildPropertyTree(Dictionary<string, List<FileDifference>> propertyGroups)
    {
        var rootNodes = new List<PropertyTreeNode>();
        var nodeMap = new Dictionary<string, PropertyTreeNode>(); // Track all nodes by full path
        
        foreach (var kvp in propertyGroups)
        {
            var path = kvp.Key;
            var differences = kvp.Value;
            
            // Normalize path - remove array indices like [0], [1], [*]
            var normalizedPath = System.Text.RegularExpressions.Regex.Replace(path, @"\[\d*\*?\]", "");
            var segments = normalizedPath.Split('.', StringSplitOptions.RemoveEmptyEntries);
            
            if (segments.Length == 0) continue;
            
            // Build the tree structure
            List<PropertyTreeNode> currentLevel = rootNodes;
            PropertyTreeNode parentNode = null;
            string currentPath = "";
            
            for (int i = 0; i < segments.Length; i++)
            {
                var segment = segments[i];
                currentPath = string.IsNullOrEmpty(currentPath) ? segment : $"{currentPath}.{segment}";
                var isLeaf = (i == segments.Length - 1);
                
                PropertyTreeNode existingNode = null;
                if (nodeMap.TryGetValue(currentPath, out var mapped))
                {
                    existingNode = mapped;
                }
                
                if (existingNode == null)
                {
                    var newNode = new PropertyTreeNode(segment, isLeaf ? path : currentPath)
                    {
                        IsLeaf = isLeaf,
                        DifferenceCount = isLeaf ? differences.Count : 0,
                        Differences = isLeaf ? differences : new List<FileDifference>()
                    };
                    newNode.Expanded = i < 2; // Expand first 2 levels by default
                    
                    currentLevel.Add(newNode);
                    nodeMap[currentPath] = newNode;
                    parentNode = newNode;
                    currentLevel = newNode.Children?.OfType<PropertyTreeNode>().ToList() ?? new List<PropertyTreeNode>();
                    
                    // Ensure children list is initialized
                    if (newNode.Children == null)
                        newNode.Children = new List<TreeItemData<string>>();
                    currentLevel = newNode.Children.OfType<PropertyTreeNode>().ToList();
                }
                else
                {
                    if (isLeaf)
                    {
                        // This path leads to a leaf - update the node to be a leaf
                        existingNode.IsLeaf = true;
                        existingNode.FullPath = path;
                        existingNode.DifferenceCount += differences.Count;
                        existingNode.Differences.AddRange(differences);
                    }
                    parentNode = existingNode;
                    currentLevel = existingNode.Children?.OfType<PropertyTreeNode>().ToList() ?? new List<PropertyTreeNode>();
                }
                
                // Add to parent's children if this is a new node
                if (parentNode != null && i > 0)
                {
                    var parentPath = string.Join(".", segments.Take(i));
                    if (nodeMap.TryGetValue(parentPath, out var parent))
                    {
                        if (parent.Children == null)
                            parent.Children = new List<TreeItemData<string>>();
                        
                        if (!parent.Children.OfType<PropertyTreeNode>().Any(c => c.FullPath == currentPath))
                        {
                            parent.Children.Add(nodeMap[currentPath]);
                        }
                    }
                }
            }
        }
        
        // Calculate aggregate counts for parent nodes
        foreach (var node in rootNodes)
        {
            CalculateNodeCounts(node);
        }
        
        return rootNodes.Cast<TreeItemData<string>>().ToList();
    }
    
    private int CalculateNodeCounts(PropertyTreeNode node)
    {
        var children = node.Children?.OfType<PropertyTreeNode>().ToList() ?? new List<PropertyTreeNode>();
        if (node.IsLeaf && !children.Any())
        {
            return node.DifferenceCount;
        }
        
        int totalCount = node.DifferenceCount; // Include own count if it's also a leaf
        foreach (var child in children)
        {
            totalCount += CalculateNodeCounts(child);
        }
        node.DifferenceCount = totalCount;
        return totalCount;
    }
    
    private int CountLeafNodes(TreeItemData<string> treeItem)
    {
        var node = treeItem as PropertyTreeNode;
        if (node == null) return 0;
        
        var children = node.Children?.OfType<PropertyTreeNode>().ToList() ?? new List<PropertyTreeNode>();
        if (node.IsLeaf && !children.Any())
            return 1;
        
        int count = node.IsLeaf ? 1 : 0;
        foreach (var child in node.Children)
        {
            count += CountLeafNodes(child);
        }
        return count;
    }
    
    private void SelectTreeNode(TreeItemData<string> treeItem)
    {
        var node = treeItem as PropertyTreeNode;
        if (node == null) return;
        
        if (node.IsLeaf)
        {
            SelectedValueProperty = node.FullPath;
        }
        else
        {
            // Toggle expansion for non-leaf nodes
            node.Expanded = !node.Expanded;
        }
    }
    
    private void ExpandAllValueNodes()
    {
        foreach (var node in _valueTreeNodes)
            SetExpandedRecursive(node, true);
        StateHasChanged();
    }
    
    private void CollapseAllValueNodes()
    {
        foreach (var node in _valueTreeNodes)
            SetExpandedRecursive(node, false);
        StateHasChanged();
    }
    
    private void ExpandAllOrderNodes()
    {
        foreach (var node in _orderTreeNodes)
            SetExpandedRecursive(node, true);
        StateHasChanged();
    }
    
    private void CollapseAllOrderNodes()
    {
        foreach (var node in _orderTreeNodes)
            SetExpandedRecursive(node, false);
        StateHasChanged();
    }
    
    private void SelectOrderTreeNode(TreeItemData<string> treeItem)
    {
        var node = treeItem as PropertyTreeNode;
        if (node == null) return;
        
        if (node.IsLeaf)
        {
            SelectedOrderProperty = node.FullPath;
        }
        else
        {
            // Toggle expansion for non-leaf nodes
            node.Expanded = !node.Expanded;
        }
    }
    
    private void SetExpandedRecursive(TreeItemData<string> treeItem, bool expanded)
    {
        treeItem.Expanded = expanded;
        if (treeItem.Children != null)
        {
            foreach (var child in treeItem.Children)
                SetExpandedRecursive(child, expanded);
        }
    }
    
    private void SelectValueProperty(string prop) { SelectedValueProperty = prop; }
    private void SelectOrderProperty(string prop) { SelectedOrderProperty = prop; }
    private void SelectCriticalProperty(string prop) { SelectedCriticalProperty = prop; }
    
    private IEnumerable<KeyValuePair<string, List<FileDifference>>> GetFilteredValueProperties()
    {
        if (string.IsNullOrWhiteSpace(ValuePropertyFilter))
            return _valuePropertyGroups;
        return _valuePropertyGroups.Where(kvp => kvp.Key.Contains(ValuePropertyFilter, StringComparison.OrdinalIgnoreCase));
    }
    
    private IEnumerable<KeyValuePair<string, List<FileDifference>>> GetFilteredOrderProperties()
    {
        if (string.IsNullOrWhiteSpace(OrderPropertyFilter))
            return _orderPropertyGroups;
        return _orderPropertyGroups.Where(kvp => kvp.Key.Contains(OrderPropertyFilter, StringComparison.OrdinalIgnoreCase));
    }
    
    private IEnumerable<KeyValuePair<string, List<FileDifference>>> GetFilteredCriticalProperties()
    {
        if (string.IsNullOrWhiteSpace(CriticalPropertyFilter))
            return _criticalPropertyGroups;
        return _criticalPropertyGroups.Where(kvp => kvp.Key.Contains(CriticalPropertyFilter, StringComparison.OrdinalIgnoreCase));
    }
    
    private int GetTotalFilesAnalyzed() => Analysis?.TotalFilesAnalyzed ?? 0;
    private int GetTotalFilesWithDifferences() => Analysis?.FilesWithDifferences ?? 0;
    private int GetFilesWithoutDifferences() => GetTotalFilesAnalyzed() - GetTotalFilesWithDifferences();
    private int GetFilesWithErrorsCount() => FolderComparisonResult?.FilePairResults?.Count(r => r.HasError) ?? 0;
    private IEnumerable<FilePairComparisonResult> GetFilesWithErrors() => 
        FolderComparisonResult?.FilePairResults?.Where(r => r.HasError) ?? Enumerable.Empty<FilePairComparisonResult>();
    
    // Use the analyzer's categorization directly to avoid double-counting
    // Value Diffs = ConsistentValueDifferences + GeneralValueDifferences (excludes NullValueChange/ItemRemoved which go to "missing")
    private int GetValueDifferencesCount() => 
        (Analysis?.ConsistentValueDifferences?.Sum(p => p.OccurenceCount) ?? 0) +
        (Analysis?.GeneralValueDifferences?.Sum(p => p.OccurenceCount) ?? 0);
    
    // Missing Properties = ConsistentlyMissingProperties + MissingCollectionElements (NullValueChange, ItemRemoved)
    private int GetMissingPropertiesCount() => 
        (Analysis?.ConsistentlyMissingProperties?.Sum(p => p.OccurenceCount) ?? 0) +
        (Analysis?.MissingCollectionElements?.Sum(p => p.OccurenceCount) ?? 0);
    
    // Order Diffs = ElementOrderDifferences only (CollectionItemChanged)
    private int GetOrderingDifferencesCount() => 
        Analysis?.ElementOrderDifferences?.Sum(p => p.OccurenceCount) ?? 0;
    
    // Uncategorized = UncategorizedDifferences
    private int GetUncategorizedCount() => 
        Analysis?.UncategorizedDifferences?.Sum(p => p.OccurenceCount) ?? 0;
    
    // Critical = CriticalMissingElements
    private int GetCriticalIssuesCount() => 
        Analysis?.CriticalMissingElements?.Sum(p => p.OccurenceCount) ?? 0;
    
    private int GetTotalDifferencesCount() => Analysis?.TotalDifferencesFound ?? 0;
    
    private IEnumerable<DifferenceGridItem> GetFilteredAllDifferences()
    {
        if (string.IsNullOrWhiteSpace(AllDifferencesFilter))
            return _allDifferences;
        return _allDifferences.Where(d => 
            d.PropertyPath.Contains(AllDifferencesFilter, StringComparison.OrdinalIgnoreCase) ||
            d.FileName.Contains(AllDifferencesFilter, StringComparison.OrdinalIgnoreCase) ||
            d.ExpectedValue.Contains(AllDifferencesFilter, StringComparison.OrdinalIgnoreCase) ||
            d.ActualValue.Contains(AllDifferencesFilter, StringComparison.OrdinalIgnoreCase));
    }
    
    private bool IsValueDifference(DifferenceCategory category)
    {
        return category == DifferenceCategory.NumericValueChanged ||
               category == DifferenceCategory.TextContentChanged ||
               category == DifferenceCategory.BooleanValueChanged ||
               category == DifferenceCategory.DateTimeChanged ||
               category == DifferenceCategory.ValueChanged ||
               category == DifferenceCategory.GeneralValueChanged ||
               category == DifferenceCategory.NullValueChange;
    }
    
    private bool IsOrderingDifference(DifferenceCategory category)
    {
        return category == DifferenceCategory.CollectionItemChanged ||
               category == DifferenceCategory.ItemAdded ||
               category == DifferenceCategory.ItemRemoved;
    }
    
    private string ExtractBasePropertyPath(string fullPattern)
    {
        var cleaned = System.Text.RegularExpressions.Regex.Replace(fullPattern, @"\[\d*\*?\]", "");
        var parts = cleaned.Split('_');
        if (parts.Length > 1 && !string.IsNullOrEmpty(parts[0]))
            cleaned = parts[0];
        return cleaned;
    }
    
    private string GetPropertyDisplayName(string propertyPath)
    {
        if (string.IsNullOrEmpty(propertyPath)) return propertyPath;
        var parts = propertyPath.Split('.');
        return parts.Length > 0 ? parts[parts.Length - 1] : propertyPath;
    }
    
    private string FormatValue(object value)
    {
        if (value == null) return "null";
        if (value is DateTime dt) return dt.ToString("yyyy-MM-dd HH:mm:ss");
        var str = value.ToString() ?? "null";
        return str.Length > 100 ? str.Substring(0, 97) + "..." : str;
    }
    
    private void RefreshAnalysis()
    {
        BuildPropertyGroups();
        StateHasChanged();
    }
    
    private async Task NavigateToFilePair(string fileName)
    {
        if (OnFileSelected.HasDelegate && !string.IsNullOrEmpty(fileName))
        {
            await OnFileSelected.InvokeAsync(fileName);
        }
    }
    
    private void ExportResults() { }
}
