@using ComparisonTool.Core.Comparison.Configuration
@using MudBlazor

<MudPaper Elevation="2" Class="pa-4">
    <MudStack Spacing="3">
        <!-- Header -->
        <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                <MudIcon Icon="@Icons.Material.Filled.AutoAwesome" Color="Color.Primary" />
                <MudText Typo="Typo.h6">Smart Ignore Rules</MudText>
                <MudChip T="string" Size="Size.Small" Color="Color.Secondary">@SmartIgnoreRules.Count active</MudChip>
            </MudStack>
            <MudStack Row="true" Spacing="1">
                <MudButton Variant="Variant.Outlined" 
                           Size="Size.Small"
                           Color="Color.Success"
                           StartIcon="@Icons.Material.Filled.Star"
                           OnClick="ShowPresetsDialog">
                    Presets
                </MudButton>
                <MudButton Variant="Variant.Outlined" 
                           Size="Size.Small"
                           StartIcon="@Icons.Material.Filled.Add"
                           OnClick="ShowCustomRuleDialog">
                    Custom Rule
                </MudButton>
                <MudButton Variant="Variant.Outlined" 
                           Size="Size.Small"
                           Color="Color.Error"
                           StartIcon="@Icons.Material.Filled.Delete"
                           OnClick="ClearAllRules" 
                           Disabled="@(!SmartIgnoreRules.Any())">
                    Clear All
                </MudButton>
            </MudStack>
        </MudStack>

        <!-- Body -->
        @if (!SmartIgnoreRules.Any())
        {
            <MudAlert Severity="Severity.Info" Variant="Variant.Outlined">
                <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                    <MudIcon Icon="@Icons.Material.Filled.Info" />
                    <MudText>No smart ignore rules configured. Use <strong>Presets</strong> for quick setup or <strong>Custom Rule</strong> for specific needs.</MudText>
                </MudStack>
            </MudAlert>
        }
        else
        {
            <MudGrid>
                <MudItem xs="12" md="6">
                    <MudText Typo="Typo.subtitle2" Class="mb-2">Quick Toggles</MudText>
                    <MudStack Spacing="1">
                        <MudSwitch T="bool"
                                   Value="HasIdFieldsRule"
                                   ValueChanged="@((bool val) => ToggleIdFields())"
                                   Color="Color.Primary"
                                   Label="Ignore ID fields (Id, Guid, Key, etc.)" />
                        <MudSwitch T="bool"
                                   Value="HasTimestampsRule"
                                   ValueChanged="@((bool val) => ToggleTimestamps())"
                                   Color="Color.Warning"
                                   Label="Ignore timestamps (DateTime, CreatedDate, etc.)" />
                        <MudSwitch T="bool"
                                   Value="HasMetadataRule"
                                   ValueChanged="@((bool val) => ToggleMetadata())"
                                   Color="Color.Info"
                                   Label="Ignore metadata (Version, ETag, etc.)" />
                        <MudSwitch T="bool"
                                   Value="HasCollectionOrderRule"
                                   ValueChanged="@((bool val) => ToggleCollectionOrder())"
                                   Color="Color.Success"
                                   Label="Ignore collection ordering" />
                    </MudStack>
                </MudItem>
                <MudItem xs="12" md="6">
                    <MudText Typo="Typo.subtitle2" Class="mb-2">Active Rules</MudText>
                    <MudPaper Outlined="true" Style="max-height: 200px; overflow-y: auto;">
                        @foreach (var rule in SmartIgnoreRules.Where(r => r.IsEnabled).OrderBy(r => r.Type).ThenBy(r => r.Value))
                        {
                            <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Class="pa-2">
                                <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                                    <MudText Typo="Typo.caption" Color="Color.Secondary">@GetRuleTypeIcon(rule.Type)</MudText>
                                    <MudText Typo="Typo.body2">@rule.Description</MudText>
                                </MudStack>
                                <MudIconButton Icon="@Icons.Material.Filled.Close"
                                               Size="Size.Small"
                                               Color="Color.Default"
                                               OnClick="@(() => RemoveRule(rule))" />
                            </MudStack>
                            <MudDivider />
                        }
                    </MudPaper>
                </MudItem>
            </MudGrid>
        }
    </MudStack>
</MudPaper>

<!-- Presets Dialog -->
<MudDialog @bind-Visible="showPresetsDialog" Options="@(new DialogOptions { MaxWidth = MaxWidth.Large, FullWidth = true })">
    <TitleContent>
        <MudText Typo="Typo.h6">Smart Ignore Presets</MudText>
    </TitleContent>
    <DialogContent>
        <MudGrid>
            @foreach (var preset in SmartIgnorePresets.AllPresets)
            {
                <MudItem xs="12" md="6">
                    <MudPaper Elevation="1" Class="pa-3" Style="height: 100%;">
                        <MudStack Spacing="2">
                            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                                <MudText Typo="Typo.subtitle1">@GetPresetIcon(preset.Key) @preset.Key</MudText>
                                <MudChip T="string" Size="Size.Small" Color="Color.Secondary">@preset.Value.Count rules</MudChip>
                            </MudStack>
                            <MudText Typo="Typo.body2" Color="Color.Secondary">
                                @GetPresetDescription(preset.Key)
                            </MudText>
                            <MudText Typo="Typo.caption" Color="Color.Secondary">Rules:</MudText>
                            <ul style="font-size: 0.85rem; margin: 0; padding-left: 1.25rem;">
                                @foreach (var rule in preset.Value.Take(3))
                                {
                                    <li>@rule.Description</li>
                                }
                                @if (preset.Value.Count > 3)
                                {
                                    <li><em>...and @(preset.Value.Count - 3) more</em></li>
                                }
                            </ul>
                            <MudButton Variant="Variant.Filled" 
                                       Color="Color.Primary" 
                                       Size="Size.Small"
                                       FullWidth="true"
                                       OnClick="@(() => ApplyPreset(preset.Key))">
                                Apply Preset
                            </MudButton>
                        </MudStack>
                    </MudPaper>
                </MudItem>
            }
        </MudGrid>
    </DialogContent>
    <DialogActions>
        <MudButton Variant="Variant.Text" OnClick="ClosePresetsDialog">Close</MudButton>
    </DialogActions>
</MudDialog>

<!-- Custom Rule Dialog -->
<MudDialog @bind-Visible="showCustomRuleDialog">
    <TitleContent>
        <MudText Typo="Typo.h6">Add Custom Ignore Rule</MudText>
    </TitleContent>
    <DialogContent>
        <MudStack Spacing="3">
            <MudSelect T="SmartIgnoreType" 
                       Value="NewRuleType"
                       ValueChanged="@((SmartIgnoreType val) => NewRuleType = val)"
                       Label="Rule Type"
                       Variant="Variant.Outlined">
                <MudSelectItem Value="SmartIgnoreType.PropertyName">Property Name (exact match)</MudSelectItem>
                <MudSelectItem Value="SmartIgnoreType.NamePattern">Name Pattern (with wildcards)</MudSelectItem>
                <MudSelectItem Value="SmartIgnoreType.PropertyType">Property Type</MudSelectItem>
            </MudSelect>
            
            @if (NewRuleType == SmartIgnoreType.PropertyName)
            {
                <MudTextField T="string" 
                              Value="NewRuleValue"
                              ValueChanged="@((string val) => NewRuleValue = val)"
                              Label="Value"
                              Variant="Variant.Outlined"
                              Placeholder="e.g., Id, Timestamp, Status"
                              HelperText="Enter exact property name to ignore" />
            }
            else if (NewRuleType == SmartIgnoreType.NamePattern)
            {
                <MudTextField T="string" 
                              Value="NewRuleValue"
                              ValueChanged="@((string val) => NewRuleValue = val)"
                              Label="Value"
                              Variant="Variant.Outlined"
                              Placeholder="e.g., *Id, Request*, *Date"
                              HelperText="Use * for wildcards (e.g., *Id ignores UserId, ProductId, etc.)" />
            }
            else if (NewRuleType == SmartIgnoreType.PropertyType)
            {
                <MudSelect T="string" 
                           Value="NewRuleValue"
                           ValueChanged="@((string val) => NewRuleValue = val)"
                           Label="Property Type"
                           Variant="Variant.Outlined"
                           HelperText="All properties of this type will be ignored">
                    <MudSelectItem Value="@("System.DateTime")">DateTime</MudSelectItem>
                    <MudSelectItem Value="@("System.Guid")">Guid</MudSelectItem>
                    <MudSelectItem Value="@("System.String")">String</MudSelectItem>
                    <MudSelectItem Value="@("System.Int32")">Integer</MudSelectItem>
                    <MudSelectItem Value="@("System.Boolean")">Boolean</MudSelectItem>
                </MudSelect>
            }
            
            <MudTextField T="string" 
                          Value="NewRuleDescription"
                          ValueChanged="@((string val) => NewRuleDescription = val)"
                          Label="Description (optional)"
                          Variant="Variant.Outlined"
                          Placeholder="Describe what this rule does" />
        </MudStack>
    </DialogContent>
    <DialogActions>
        <MudButton Variant="Variant.Text" OnClick="CloseCustomRuleDialog">Cancel</MudButton>
        <MudButton Variant="Variant.Filled" 
                   Color="Color.Primary" 
                   OnClick="AddCustomRule" 
                   Disabled="@string.IsNullOrWhiteSpace(NewRuleValue)">
            Add Rule
        </MudButton>
    </DialogActions>
</MudDialog>

@code {
    [Parameter] public List<SmartIgnoreRule> SmartIgnoreRules { get; set; } = new();
    [Parameter] public EventCallback<SmartIgnoreRule> OnRuleAdded { get; set; }
    [Parameter] public EventCallback<SmartIgnoreRule> OnRuleRemoved { get; set; }
    [Parameter] public EventCallback<string> OnPresetApplied { get; set; }
    [Parameter] public EventCallback OnRulesCleared { get; set; }

    private bool showPresetsDialog = false;
    private bool showCustomRuleDialog = false;

    // Custom rule creation
    private SmartIgnoreType NewRuleType = SmartIgnoreType.PropertyName;
    private string NewRuleValue = "";
    private string NewRuleDescription = "";

    // Quick toggle states
    private bool HasIdFieldsRule => SmartIgnoreRules.Any(r => r.Value == "Id" && r.Type == SmartIgnoreType.PropertyName);
    private bool HasTimestampsRule => SmartIgnoreRules.Any(r => r.Value == "System.DateTime" && r.Type == SmartIgnoreType.PropertyType);
    private bool HasMetadataRule => SmartIgnoreRules.Any(r => r.Value == "Version" && r.Type == SmartIgnoreType.PropertyName);
    private bool HasCollectionOrderRule => SmartIgnoreRules.Any(r => r.Type == SmartIgnoreType.CollectionOrdering);

    private void ShowPresetsDialog()
    {
        showPresetsDialog = true;
    }

    private void ClosePresetsDialog()
    {
        showPresetsDialog = false;
    }

    private void ShowCustomRuleDialog()
    {
        ResetCustomRuleForm();
        showCustomRuleDialog = true;
    }

    private void CloseCustomRuleDialog()
    {
        showCustomRuleDialog = false;
    }

    private void ResetCustomRuleForm()
    {
        NewRuleType = SmartIgnoreType.PropertyName;
        NewRuleValue = "";
        NewRuleDescription = "";
    }

    private async Task ApplyPreset(string presetName)
    {
        await OnPresetApplied.InvokeAsync(presetName);
        ClosePresetsDialog();
        StateHasChanged();
    }

    private async Task AddCustomRule()
    {
        if (string.IsNullOrWhiteSpace(NewRuleValue))
            return;

        var rule = new SmartIgnoreRule
        {
            Type = NewRuleType,
            Value = NewRuleValue,
            Description = string.IsNullOrWhiteSpace(NewRuleDescription) 
                ? GetAutoDescription(NewRuleType, NewRuleValue)
                : NewRuleDescription,
            IsEnabled = true
        };

        await OnRuleAdded.InvokeAsync(rule);
        CloseCustomRuleDialog();
        StateHasChanged();
    }

    private async Task RemoveRule(SmartIgnoreRule rule)
    {
        await OnRuleRemoved.InvokeAsync(rule);
        StateHasChanged();
    }

    private async Task ClearAllRules()
    {
        await OnRulesCleared.InvokeAsync();
        StateHasChanged();
    }

    private async Task ToggleIdFields()
    {
        if (HasIdFieldsRule)
        {
            // Remove ID-related rules
            var idRules = SmartIgnorePresets.IgnoreIdFields;
            foreach (var rule in idRules)
            {
                await OnRuleRemoved.InvokeAsync(rule);
            }
        }
        else
        {
            // Add ID-related rules
            await OnPresetApplied.InvokeAsync("ID Fields");
        }
        StateHasChanged();
    }

    private async Task ToggleTimestamps()
    {
        if (HasTimestampsRule)
        {
            // Remove timestamp-related rules
            var timestampRules = SmartIgnorePresets.IgnoreTimestamps;
            foreach (var rule in timestampRules)
            {
                await OnRuleRemoved.InvokeAsync(rule);
            }
        }
        else
        {
            // Add timestamp-related rules
            await OnPresetApplied.InvokeAsync("Timestamps");
        }
        StateHasChanged();
    }

    private async Task ToggleMetadata()
    {
        if (HasMetadataRule)
        {
            // Remove metadata-related rules
            var metadataRules = SmartIgnorePresets.IgnoreMetadata;
            foreach (var rule in metadataRules)
            {
                await OnRuleRemoved.InvokeAsync(rule);
            }
        }
        else
        {
            // Add metadata-related rules
            await OnPresetApplied.InvokeAsync("Metadata");
        }
        StateHasChanged();
    }

    private async Task ToggleCollectionOrder()
    {
        if (HasCollectionOrderRule)
        {
            // Remove collection ordering rule
            var rule = SmartIgnoreRules.FirstOrDefault(r => r.Type == SmartIgnoreType.CollectionOrdering);
            if (rule != null)
            {
                await OnRuleRemoved.InvokeAsync(rule);
            }
        }
        else
        {
            // Add collection ordering rule
            var rule = SmartIgnoreRule.IgnoreCollectionOrdering();
            await OnRuleAdded.InvokeAsync(rule);
        }
        StateHasChanged();
    }

    private string GetRuleTypeIcon(SmartIgnoreType type)
    {
        return type switch
        {
            SmartIgnoreType.PropertyName => "ðŸ·ï¸",
            SmartIgnoreType.NamePattern => "ðŸ”",
            SmartIgnoreType.PropertyType => "ðŸ“¦",
            SmartIgnoreType.CollectionOrdering => "ðŸ“‹",
            _ => "â“"
        };
    }

    private string GetPresetIcon(string presetName)
    {
        return presetName switch
        {
            "ID Fields" => "ðŸ”‘",
            "Timestamps" => "â°",
            "Metadata" => "ðŸ“Š",
            "Functional Comparison" => "âš¡",
            _ => "ðŸ“‹"
        };
    }

    private string GetPresetDescription(string presetName)
    {
        return presetName switch
        {
            "ID Fields" => "Ignores all identifier fields like Id, Guid, Key, and similar patterns.",
            "Timestamps" => "Ignores all DateTime fields and timestamp-related properties.",
            "Metadata" => "Ignores system metadata like Version, ETag, RequestId, etc.",
            "Functional Comparison" => "Complete preset for business logic comparison - ignores technical fields, focuses on data.",
            _ => "Custom preset"
        };
    }

    private string GetAutoDescription(SmartIgnoreType type, string value)
    {
        return type switch
        {
            SmartIgnoreType.PropertyName => $"Ignore all '{value}' properties",
            SmartIgnoreType.NamePattern => $"Ignore properties matching '{value}'",
            SmartIgnoreType.PropertyType => $"Ignore all {value} properties",
            SmartIgnoreType.CollectionOrdering => "Ignore collection ordering",
            _ => $"Custom rule: {value}"
        };
    }
}