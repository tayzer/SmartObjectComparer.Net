@namespace ComparisonTool.Web.Components.Comparison
@using System.Text.RegularExpressions
@using ComparisonTool.Core
@using ComparisonTool.Core.Utilities
@using ComparisonTool.Core.Comparison.Analysis
@using ComparisonTool.Core.Comparison.Results
@using ComparisonTool.Web.Services
@using KellermanSoftware.CompareNetObjects
@using Microsoft.AspNetCore.Components
@inject RawContentService RawContentService

<style>
    .diff-expected-cell {
        background-color: rgba(46, 125, 50, 0.1) !important;
        border-left: 3px solid #2e7d32 !important;
    }
    
    .diff-actual-cell {
        background-color: rgba(211, 47, 47, 0.1) !important;
        border-left: 3px solid #d32f2f !important;
    }
    
    .diff-value-expected {
        background-color: rgba(46, 125, 50, 0.2);
        color: #1b5e20;
        font-weight: 600;
        padding: 2px 8px;
        border-radius: 4px;
        font-family: 'Consolas', 'Monaco', monospace;
        font-size: 0.875rem;
    }
    
    .diff-value-actual {
        background-color: rgba(211, 47, 47, 0.2);
        color: #b71c1c;
        font-weight: 600;
        padding: 2px 8px;
        border-radius: 4px;
        font-family: 'Consolas', 'Monaco', monospace;
        font-size: 0.875rem;
    }
</style>

<MudPaper Elevation="2" Class="mt-4" id="detailed-differences-section">
    <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Class="pa-3" Style="background: var(--mud-palette-surface);">
        <MudStack Spacing="0">
            <MudText Typo="Typo.h6">
                <MudIcon Icon="@Icons.Material.Filled.Compare" Class="mr-2" />
                Detailed Comparison
            </MudText>
            <MudText Typo="Typo.caption" Color="Color.Default">
                @SelectedPair.File1Name vs @SelectedPair.File2Name
            </MudText>
        </MudStack>
        <MudStack Row="true" Spacing="2" AlignItems="AlignItems.Center">
            <MudTooltip Text="Toggle between structured differences and full file side-by-side comparison">
                <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                    <MudIcon Icon="@Icons.Material.Filled.ViewList" Size="Size.Small" Color="@(!showFullFileView ? Color.Primary : Color.Default)" />
                    <MudSwitch T="bool" @bind-Value="showFullFileView" 
                               Color="Color.Primary" 
                               Label="" 
                               Class="ma-0" />
                    <MudIcon Icon="@Icons.Material.Filled.ViewColumn" Size="Size.Small" Color="@(showFullFileView ? Color.Primary : Color.Default)" />
                    <MudText Typo="Typo.caption" Color="Color.Secondary">@(showFullFileView ? "Full File View" : "Structured View")</MudText>
                </MudStack>
            </MudTooltip>
            <MudButton Variant="Variant.Outlined" 
                       Color="Color.Primary"
                       Size="Size.Small" 
                       StartIcon="@Icons.Material.Filled.Download"
                       OnClick="ExportResults">
                Export This Result
            </MudButton>
        </MudStack>
    </MudStack>
    <MudDivider />
</MudPaper>

@if (showFullFileView)
{
    <MudPaper Elevation="2" Class="mt-4 pa-4">
        <SideBySideFileView ContentA="@rawContentA"
                            ContentB="@rawContentB"
                            FileNameA="@SelectedPair.File1Name"
                            FileNameB="@SelectedPair.File2Name"
                            IsTruncatedA="@rawContentTruncatedA"
                            IsTruncatedB="@rawContentTruncatedB"
                            IsLoading="@isLoadingRawContent"
                            ErrorMessage="@rawContentErrorMessage" />
    </MudPaper>
}
else if (!DifferenceSummary.AreEqual)
{
    <MudPaper Elevation="2" Class="mt-4">
        <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Class="pa-3">
            <MudText Typo="Typo.h6">
                <MudIcon Icon="@Icons.Material.Filled.List" Class="mr-2" />
                All Differences
            </MudText>
            <MudButton Variant="Variant.Text" 
                       Size="Size.Small" 
                       OnClick="OnToggleShowAll">
                @(ShowAllDifferences ? "Show Top 100 Per Group" : "Show All Differences")
            </MudButton>
        </MudStack>
        <MudDivider />
        
        <div class="pa-4">
            <MudTextField @bind-Value="SearchFilter" 
                          Placeholder="Search differences..." 
                          Variant="Variant.Outlined" 
                          Adornment="Adornment.Start" 
                          AdornmentIcon="@Icons.Material.Filled.Search"
                          Immediate="true"
                          Margin="Margin.Dense"
                          Class="mb-4" />
            
            @foreach (var group in GetFilteredGroups())
            {
                string groupKey = group.Key;
                bool isCollapsed = IsGroupCollapsed(groupKey);
                var diffCount = group.Count();
                
                <MudPaper Elevation="1" Class="mb-3">
                    <MudStack Row="true" 
                              Justify="Justify.SpaceBetween" 
                              AlignItems="AlignItems.Center" 
                              Class="pa-3 cursor-pointer"
                              Style="background: var(--mud-palette-background-grey);"
                              @onclick="() => ToggleGroupCollapse(groupKey)">
                        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                            <MudIcon Icon="@(isCollapsed ? Icons.Material.Filled.ChevronRight : Icons.Material.Filled.ExpandMore)" />
                            <MudText Typo="Typo.subtitle1"><strong>@groupKey</strong></MudText>
                            <MudChip T="string" Size="Size.Small" Color="Color.Error">@diffCount diffs</MudChip>
                        </MudStack>
                    </MudStack>
                    
                    @if (!isCollapsed)
                    {
                        <MudDivider />
                        <MudDataGrid T="DifferenceItem" 
                                     Items="@GetGroupItems(group)" 
                                     Dense="true" 
                                     Hover="true"
                                     Striped="false"
                                     Filterable="false"
                                     SortMode="SortMode.Single"
                                     RowsPerPage="25">
                            <Columns>
                                <PropertyColumn Property="x => x.PropertyName" Title="Property" Sortable="true">
                                    <CellTemplate>
                                        <code style="font-size: 0.85rem;">@context.Item.PropertyName</code>
                                    </CellTemplate>
                                </PropertyColumn>
                                <TemplateColumn Title="Expected (A)" CellClass="diff-expected-cell">
                                    <CellTemplate>
                                        <span class="diff-value-expected">@context.Item.ExpectedValue</span>
                                    </CellTemplate>
                                </TemplateColumn>
                                <TemplateColumn Title="Actual (B)" CellClass="diff-actual-cell">
                                    <CellTemplate>
                                        <span class="diff-value-actual">@context.Item.ActualValue</span>
                                    </CellTemplate>
                                </TemplateColumn>
                            </Columns>
                            <PagerContent>
                                <MudDataGridPager T="DifferenceItem" />
                            </PagerContent>
                        </MudDataGrid>
                        
                        @if (diffCount > 100 && !ShowAllDifferences)
                        {
                            <MudAlert Severity="Severity.Info" Variant="Variant.Text" Dense="true" Class="mx-3 mb-3">
                                And @(diffCount - 100) more differences in this group...
                            </MudAlert>
                        }
                    }
                </MudPaper>
            }
        </div>
    </MudPaper>
}

@code {
    [Parameter]
    public FilePairComparisonResult SelectedPair { get; set; }

    [Parameter]
    public DifferenceSummary DifferenceSummary { get; set; }

    [Parameter]
    public ComparisonResult ComparisonResult { get; set; }

    [Parameter]
    public bool ShowAllDifferences { get; set; }

    [Parameter]
    public EventCallback OnToggleShowAll { get; set; }

    [Parameter]
    public EventCallback OnExportResults { get; set; }

    [Parameter]
    public MultiFolderComparisonResult FolderResult { get; set; }

    private string SearchFilter { get; set; } = "";
    private Dictionary<string, bool> groupCollapsedStates = new Dictionary<string, bool>();
    
    // Full file view state
    private bool showFullFileView;
    private string rawContentA = "";
    private string rawContentB = "";
    private bool rawContentTruncatedA;
    private bool rawContentTruncatedB;
    private bool isLoadingRawContent;
    private string? rawContentErrorMessage;
    private string? lastLoadedPairKey;
    
    // Grid item for differences
    public class DifferenceItem
    {
        public string PropertyName { get; set; } = "";
        public string ExpectedValue { get; set; } = "";
        public string ActualValue { get; set; } = "";
    }

    private IEnumerable<IGrouping<string, Difference>> GroupedDifferences { get; set; } = Enumerable.Empty<IGrouping<string, Difference>>();

    protected override void OnParametersSet()
    {
        if (ComparisonResult != null)
        {
            GroupedDifferences = (ComparisonResult.Differences ?? Enumerable.Empty<Difference>())
                .Select(d => new { Normalized = PropertyPathNormalizer.NormalizePropertyPath(d.PropertyName), Diff = d })
                .GroupBy(x => x.Normalized, x => x.Diff)
                .OrderBy(g => g.Key);

            foreach (var group in GroupedDifferences)
            {
                if (!groupCollapsedStates.ContainsKey(group.Key))
                {
                    groupCollapsedStates[group.Key] = true;
                }
            }
        }
        else
        {
            GroupedDifferences = Enumerable.Empty<IGrouping<string, Difference>>();
            groupCollapsedStates.Clear();
        }
        
        // Reset full file view when pair changes
        var currentPairKey = $"{SelectedPair?.File1Path}|{SelectedPair?.File2Path}";
        if (currentPairKey != lastLoadedPairKey)
        {
            rawContentA = "";
            rawContentB = "";
            rawContentErrorMessage = null;
            lastLoadedPairKey = null;
            // Keep showFullFileView toggle state across pair changes but content needs reload
        }
        
        base.OnParametersSet();
    }
    
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (showFullFileView && lastLoadedPairKey != $"{SelectedPair?.File1Path}|{SelectedPair?.File2Path}")
        {
            await LoadRawContentAsync();
        }
    }
    
    private async Task LoadRawContentAsync()
    {
        if (SelectedPair == null || isLoadingRawContent) return;
        
        var pairKey = $"{SelectedPair.File1Path}|{SelectedPair.File2Path}";
        if (pairKey == lastLoadedPairKey) return;
        
        isLoadingRawContent = true;
        rawContentErrorMessage = null;
        StateHasChanged();
        
        try
        {
            var result = await RawContentService.LoadRawContentAsync(SelectedPair);
            
            if (result.IsLoaded)
            {
                rawContentA = result.ContentA;
                rawContentB = result.ContentB;
                rawContentTruncatedA = result.IsTruncatedA;
                rawContentTruncatedB = result.IsTruncatedB;
            }
            else
            {
                rawContentErrorMessage = result.ErrorMessage;
            }
            
            lastLoadedPairKey = pairKey;
        }
        catch (Exception ex)
        {
            rawContentErrorMessage = $"Failed to load file content: {ex.Message}";
        }
        finally
        {
            isLoadingRawContent = false;
            StateHasChanged();
        }
    }
    
    private IEnumerable<IGrouping<string, Difference>> GetFilteredGroups()
    {
        if (string.IsNullOrWhiteSpace(SearchFilter))
            return GroupedDifferences;
            
        return GroupedDifferences.Where(g => 
            g.Key.Contains(SearchFilter, StringComparison.OrdinalIgnoreCase) ||
            g.Any(d => 
                d.PropertyName.Contains(SearchFilter, StringComparison.OrdinalIgnoreCase) ||
                FormatValue(d.Object1Value).Contains(SearchFilter, StringComparison.OrdinalIgnoreCase) ||
                FormatValue(d.Object2Value).Contains(SearchFilter, StringComparison.OrdinalIgnoreCase)));
    }
    
    private IEnumerable<DifferenceItem> GetGroupItems(IGrouping<string, Difference> group)
    {
        var items = ShowAllDifferences ? group : group.Take(100);
        return items.Select(d => new DifferenceItem
        {
            PropertyName = GetRelativePropertyName(d.PropertyName, group.Key),
            ExpectedValue = FormatValue(d.Object1Value),
            ActualValue = FormatValue(d.Object2Value)
        });
    }

    private string GetRelativePropertyName(string fullPath, string groupKey)
    {
        if (string.IsNullOrEmpty(fullPath)) return "";

        var normalizedFull = PropertyPathNormalizer.NormalizePropertyPath(fullPath);
        if (groupKey == "(Root Properties)") return normalizedFull;
        if (normalizedFull.StartsWith(groupKey))
        {
            var relative = normalizedFull.Substring(groupKey.Length);
            return relative.TrimStart('.', '[').TrimEnd(']');
        }

        return normalizedFull;
    }

    private bool IsGroupCollapsed(string groupKey)
    {
        return groupCollapsedStates.TryGetValue(groupKey, out var isCollapsed) && isCollapsed;
    }

    private void ToggleGroupCollapse(string groupKey)
    {
        if (groupCollapsedStates.ContainsKey(groupKey))
        {
            groupCollapsedStates[groupKey] = !groupCollapsedStates[groupKey];
        }
        else
        {
            groupCollapsedStates[groupKey] = false;
        }
    }

    private async Task ExportResults()
    {
        await OnExportResults.InvokeAsync();
    }

    private string FormatValue(object value)
    {
        if (value == null) return "null";

        if (value is DateTime dt)
            return dt.ToString("yyyy-MM-dd HH:mm:ss");

        var str = value.ToString() ?? "null";
        return str.Length > 100 ? str.Substring(0, 97) + "..." : str;
    }
}
